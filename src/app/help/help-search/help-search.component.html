<ocx-portal-page permission="HELP#SEARCH" helpArticleId="PAGE_HELP_SEARCH">
  <!-- slot getting data from product store -->
  <ocx-slot
    *ngIf="pdIsComponentDefined$ | async"
    [name]="pdSlotName"
    [inputs]="{ dataType: 'products', logEnabled: false, logPrefix: 'help' }"
    [outputs]="{ products: pdSlotEmitter }"
  >
  </ocx-slot>

  <ng-container *ngIf="metaData$ | async as metaData">
    <app-help-criteria
      [actions]="(actions$ | async) ?? []"
      [usedProducts]="metaData.usedProducts"
      (searchEmitter)="onSearch($event)"
      (resetSearchEmitter)="onCriteriaReset()"
    ></app-help-criteria>

    <ocx-page-content>
      <p-message
        *ngIf="loadingMetaData"
        id="am_search_message_loading"
        severity="info"
        styleClass="m-3 p-2"
        [text]="'ACTIONS.LOADING' | translate"
      ></p-message>
      <p-message
        *ngIf="exceptionKey"
        id="hm_search_error_message"
        severity="error"
        styleClass="m-3 p-2"
        [text]="exceptionKey! | translate"
      ></p-message>

      <ng-container *ngIf="data$ | async as data">
        <!-- placed here to avoid https://angular.dev/errors/NG0100 -->
        <p-message
          *ngIf="searching"
          id="am_search_message_searching"
          severity="info"
          styleClass="m-3 p-2"
          [text]="'ACTIONS.SEARCH.IN_PROGRESS' | translate"
        ></p-message>
        <p-table
          *ngIf="!(searching || exceptionKey)"
          #dataTable
          id="hm_search_table"
          styleClass="mx-3 mb-2"
          [value]="data"
          [columns]="filteredColumns"
          stateStorage="local"
          dataKey="id"
          [reorderableColumns]="false"
          [scrollable]="true"
          scrollHeight="590px"
          [rows]="10"
          [rowsPerPageOptions]="[10, 30, 100]"
          [paginator]="true"
          [alwaysShowPaginator]="true"
          paginatorPosition="bottom"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="{first} - {last} {{ 'ACTIONS.SEARCH.OF' | translate }} {totalRecords}"
        >
          <ng-template pTemplate="caption">
            <ocx-data-view-controls
              [supportedViews]="['table']"
              [enableFiltering]="true"
              [enableSorting]="false"
              (columnsChange)="onColumnsChange($event)"
              (filterChange)="onFilterChange($event, dataTable)"
              [translations]="dataViewControlsTranslations"
            ></ocx-data-view-controls>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td id="hm_search_table_no_data" colspan="16">{{ 'ACTIONS.SEARCH.NO_DATA' | translate }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="header" let-columns>
            <tr id="hm_search_table_header">
              <th
                pFrozenColumn
                id="hm_search_table_header_action"
                class="px-2 py-1 sm:py-2 border-right-1 text-center white-space-nowrap"
                [pTooltip]="'ACTIONS.TOOLTIP' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              >
                {{ 'ACTIONS.LABEL' | translate }}
              </th>
              <th
                *ngFor="let col of columns"
                [id]="'hm_search_table_header_' + col.field"
                [class]="col.css"
                [pSortableColumn]="col.field"
                [pTooltip]="col.translationPrefix + '.TOOLTIPS.' + col.header | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              >
                {{ col.translationPrefix + '.' + col.header | translate }}
                <p-sortIcon [field]="col.field"></p-sortIcon>
              </th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-row="rowIndex" let-rowData let-columns="columns">
            <tr [id]="'hm_search_table_row_' + row">
              <!-- actions -->
              <td pFrozenColumn class="py-1 border-right-1 text-center white-space-nowrap">
                <ng-container *ocxIfNotPermission="'HELP#EDIT'">
                  <p-button
                    *ocxIfPermission="'HELP#VIEW'"
                    [id]="'hm_search_table_row_' + row + '_action_view'"
                    type="button"
                    pRipple
                    [text]="true"
                    [plain]="true"
                    [rounded]="true"
                    [icon]="'pi pi-eye'"
                    (onClick)="onDetail($event, rowData, 'VIEW')"
                    [ariaLabel]="'ACTIONS.VIEW.LABEL' | translate"
                    [pTooltip]="'ACTIONS.VIEW.LABEL' | translate"
                    tooltipPosition="top"
                    tooltipEvent="hover"
                  />
                </ng-container>
                <p-button
                  *ocxIfPermission="'HELP#EDIT'"
                  [id]="'hm_search_table_row_' + row + '_action_edit'"
                  type="button"
                  pRipple
                  [text]="true"
                  [plain]="true"
                  [rounded]="true"
                  [icon]="'pi pi-pencil'"
                  (onClick)="onDetail($event, rowData, 'EDIT')"
                  [ariaLabel]="'ACTIONS.EDIT.LABEL' | translate"
                  [pTooltip]="'ACTIONS.EDIT.LABEL' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                />
                <p-button
                  *ocxIfPermission="'HELP#EDIT'"
                  [id]="'hm_search_table_row_' + row + '_action_copy'"
                  type="button"
                  pRipple
                  [text]="true"
                  [plain]="true"
                  [rounded]="true"
                  [icon]="'pi pi-copy'"
                  (onClick)="onDetail($event, rowData, 'COPY')"
                  (keydown.enter)="onDetail($event, rowData, 'COPY')"
                  (keydown.space)="onDetail($event, rowData, 'COPY')"
                  [ariaLabel]="'ACTIONS.COPY.LABEL' | translate"
                  [pTooltip]="'ACTIONS.COPY.LABEL' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                />
                <p-button
                  *ocxIfPermission="'HELP#DELETE'"
                  [id]="'hm_search_table_row_' + row + '_action_delete'"
                  type="button"
                  pRipple
                  [text]="true"
                  [plain]="true"
                  [rounded]="true"
                  [icon]="'pi pi-trash'"
                  severity="danger"
                  (onClick)="onDelete($event, rowData)"
                  (keydown.enter)="onDelete($event, rowData)"
                  (keydown.space)="onDelete($event, rowData)"
                  [ariaLabel]="'ACTIONS.DELETE.LABEL' | translate"
                  [pTooltip]="'ACTIONS.DELETE.LABEL' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                />
              </td>
              <td *ngFor="let col of columns" [id]="'hm_search_table_row_' + row + '_' + col.field" [class]="col.css">
                @switch (col.field) {
                  @case ('productName') {
                    @let displayName = getDisplayName(rowData.productName, metaData.allProducts);
                    <div
                      class="text-ellipsis-2-lines"
                      [pTooltip]="displayName ? '' : rowData.productName"
                      tooltipPosition="top"
                      tooltipEvent="hover"
                    >
                      {{ displayName ?? ('HELP_ITEM.NOT_FOUND' | translate) }}
                    </div>
                  }
                  @case ('url') {
                    <div class="text-ellipsis-2-lines word-break-all">
                      {{ prepareUrl(rowData) }}
                    </div>
                  }
                  @default {
                    <div class="text-ellipsis-2-lines word-break-all">
                      {{ rowData[col.field] }}
                    </div>
                  }
                }
              </td>
            </tr>
          </ng-template>
        </p-table>

        <!-- DELETE -->
        <p-dialog
          *ngIf="item4Delete"
          [header]="'ACTIONS.DELETE.HEADER' | translate"
          [(visible)]="displayDeleteDialog"
          [modal]="true"
          [closable]="true"
          [draggable]="true"
          [resizable]="false"
          [dismissableMask]="true"
          [style]="{ width: '500px' }"
        >
          <div class="flex column-gap-3 row-gap-1 justify-content-start align-items-center">
            <div class="pi pi-question-circle text-3xl danger-action-text"></div>
            <section class="w-11 flex flex-column row-gap-3 justify-content-start">
              <div
                id="hm_delete_message_text"
                class="mr-3 font-bold"
                [attr.aria-label]="'ACTIONS.CONFIRMATION.QUESTION' | translate"
                role="note"
              >
                {{ 'ACTIONS.DELETE.TEXT' | translate }}
              </div>
              <div
                id="hm_delete_menu_item_name"
                class="text-center danger-action-text"
                [attr.aria-label]="'HELP_ITEM.ID' | translate"
                role="note"
              >
                {{ item4Delete.itemId }}
              </div>
              <div *ngIf="item4Delete.operator">{{ 'ACTIONS.DELETE.OPERATOR_TEXT' | translate }}</div>

              <div>{{ 'ACTIONS.DELETE.NO_UNDO' | translate }}</div>
            </section>
          </div>

          <ng-template pTemplate="footer">
            <footer class="flex flex-wrap justify-content-end column-gap-2 row-gap-1">
              <p-button
                id="hm_delete_action_no"
                icon="pi pi-times"
                (onClick)="displayDeleteDialog = false"
                [label]="'ACTIONS.CONFIRMATION.NO' | translate"
                [ariaLabel]="'ACTIONS.CONFIRMATION.NO.TOOLTIP' | translate"
                [pTooltip]="'ACTIONS.CONFIRMATION.NO.TOOLTIP' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              ></p-button>
              <p-button
                id="hm_delete_action_yes"
                icon="pi pi-check"
                (onClick)="onDeleteConfirmation(data)"
                [label]="'ACTIONS.CONFIRMATION.YES' | translate"
                [ariaLabel]="'ACTIONS.CONFIRMATION.YES.TOOLTIP' | translate"
                [pTooltip]="'ACTIONS.CONFIRMATION.YES.TOOLTIP' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              ></p-button>
            </footer>
          </ng-template>
        </p-dialog>
      </ng-container>
    </ocx-page-content>

    <!-- DETAIL -->
    <app-help-detail
      [displayDialog]="displayDetailDialog"
      (hideDialogAndChanged)="onCloseDetail($event)"
      [helpItem]="item4Detail"
      [changeMode]="changeMode"
      [allProducts]="metaData.allProducts"
    ></app-help-detail>

    <!-- EXPORT -->
    <p-dialog
      [header]="'ACTIONS.EXPORT.HEADER' | translate"
      [(visible)]="displayExportDialog"
      [modal]="true"
      [closable]="true"
      [draggable]="true"
      [resizable]="true"
      [dismissableMask]="true"
      [style]="{ width: '350px' }"
      [breakpoints]="{
        '992px': '40vw',
        '800px': '50vw',
        '700px': '60vw',
        '600px': '70vw',
        '500px': '80vw',
        '400px': '100vw'
      }"
    >
      <div class="flex flex-column row-gap-1">
        <div>{{ 'HELP_ITEM.PRODUCT_LIST' | translate }}</div>
        <p-listbox
          id="hm_export_product_list"
          optionLabel="displayName"
          optionValue="name"
          [options]="metaData.usedProducts"
          [(ngModel)]="exportProductList"
          [filter]="true"
          [checkbox]="true"
          [multiple]="true"
          [metaKeySelection]="false"
          [showToggleAll]="true"
          [emptyMessage]="'ACTIONS.SEARCH.NO_DATA' | translate"
          [listStyle]="{ 'max-height': '300px' }"
        >
          <ng-template let-product pTemplate="item">
            <div class="text-responsive">
              {{ product.displayName }}
            </div>
          </ng-template>
        </p-listbox>
      </div>
      <ng-template pTemplate="footer">
        <div class="flex flex-wrap justify-content-end column-gap-2 row-gap-1">
          <p-button
            id="hm_export_action_cancel"
            icon="pi pi-times"
            (onClick)="onExportCloseDialog()"
            [label]="'ACTIONS.CANCEL' | translate"
            [ariaLabel]="'ACTIONS.TOOLTIPS.CANCEL' | translate"
            [pTooltip]="'ACTIONS.TOOLTIPS.CANCEL' | translate"
            tooltipPosition="top"
            tooltipEvent="hover"
          ></p-button>
          <p-button
            id="hm_export_action_export"
            icon="pi pi-download"
            (onClick)="onExportConfirmation()"
            [disabled]="exportProductList.length === 0"
            [label]="'ACTIONS.EXPORT.LABEL' | translate"
            [ariaLabel]="'ACTIONS.EXPORT.ITEMS_SELECTED.TOOLTIP' | translate"
            [pTooltip]="'ACTIONS.EXPORT.ITEMS_SELECTED.TOOLTIP' | translate"
            tooltipPosition="top"
            tooltipEvent="hover"
          ></p-button>
        </div>
      </ng-template>
    </p-dialog>
  </ng-container>
</ocx-portal-page>

<!-- IMPORT -->
<p-dialog
  [(visible)]="displayImportDialog"
  [header]="'ACTIONS.IMPORT.HEADER' | translate"
  [modal]="true"
  [closable]="true"
  [draggable]="true"
  [resizable]="true"
  [dismissableMask]="true"
>
  <div class="flex flex-wrap column-gap-2 row-gap-1 justify-content-end">
    <p-fileUpload
      #fileUploader
      id="hm_import_file_upload"
      mode="advanced"
      name="file"
      accept=".json"
      [maxFileSize]="1000000"
      [customUpload]="true"
      (uploadHandler)="onImportConfirmation()"
      (onImportClear)="onImportClear()"
      (onRemove)="onImportClear()"
      (onSelect)="onImportSelectFile($event)"
      [showUploadButton]="!this.importError"
      [chooseLabel]="'ACTIONS.IMPORT.CHOOSE' | translate"
      [uploadLabel]="'ACTIONS.IMPORT.UPLOAD' | translate"
      [cancelLabel]="'ACTIONS.CANCEL' | translate"
    />
  </div>
  <ng-template pTemplate="footer">
    <div class="flex flex-wrap justify-content-end column-gap-2 row-gap-1">
      <p-button
        id="hm_import_action_close"
        icon="pi pi-times"
        (onClick)="onImportCloseDialog()"
        [label]="'ACTIONS.NAVIGATION.CLOSE' | translate"
        [ariaLabel]="'ACTIONS.NAVIGATION.CLOSE' | translate"
        [pTooltip]="'ACTIONS.NAVIGATION.CLOSE.TOOLTIP' | translate"
        tooltipPosition="top"
        tooltipEvent="hover"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>
